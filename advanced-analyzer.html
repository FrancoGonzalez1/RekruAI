<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekru.AI - Advanced Analyzer</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mammoth.js for DOCX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth.js/1.4.1/mammoth.browser.min.js"></script>
    <style>
        /* Custom font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Smooth scrolling for anchor links */
        html {
            scroll-behavior: smooth;
        }
        /* Style for the drag-and-drop area */
        .drop-zone {
            border: 2px dashed #cbd5e0; /* gray-300 */
            border-radius: 0.5rem; /* rounded-md */
            padding: 2rem;
            text-align: center;
            background-color: #f8fafc; /* gray-50 */
            transition: all 0.2s ease-in-out;
        }
        .drop-zone.hover {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #e0e7ff; /* indigo-100 */
        }
        /* Progress bar styles */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* gray-200 */
            border-radius: 9999px; /* full rounded */
            overflow: hidden;
            height: 1.5rem; /* h-6 */
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: #8b5cf6; /* purple-500 */
            border-radius: 9999px; /* full rounded */
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
        }

        /* Dark Mode Styles */
        html.dark {
            background-color: #0c0a09; /* zinc-950 - very dark grey/black */
            color: #e2e8f0; /* light gray text */
        }
        html.dark body {
            background-color: #0c0a09;
            color: #e2e8f0;
        }
        html.dark header {
            background-color: #1a202c; /* darker header */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.24);
        }
        html.dark nav a {
            color: #a0aec0; /* lighter gray links */
            transition: color 0.3s ease-in-out;
        }
        html.dark nav a:hover {
            color: #667eea; /* indigo-400 hover */
        }
        html.dark section {
            background-color: #1a202c; /* darker section background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.24);
        }
        html.dark .bg-gray-100 { /* Used for internal sections/cards */
            background-color: #1a202c; /* darker gray-100 */
        }
        html.dark .bg-white { /* Used for cards/inner elements */
            background-color: #2d3748; /* darker white */
        }
        html.dark .bg-gray-50 { /* Used for contact form/benefits */
            background-color: #2d3748; /* darker gray-50 */
        }
        html.dark .text-gray-800 {
            color: #e2e8f0;
        }
        html.dark .text-gray-700 {
            color: #cbd5e0;
        }
        html.dark .text-gray-600 {
            color: #a0aec0;
        }
        html.dark .text-gray-500 {
            color: #718096;
        }
        html.dark .text-indigo-700 { /* Rekru.AI logo, saved JD links */
            color: #7c3aed; /* violet-600 */
        }
        html.dark .text-indigo-800 { /* Section headings */
            color: #9f7aea; /* purple-400 */
        }
        html.dark .text-purple-700 { /* Analyze Candidates button */
            color: #d8b4fe; /* purple-300 */
        }
        html.dark .border-gray-400 { /* Analyzer left column border */
            border-color: #4a5568; /* darker gray border */
        }
        html.dark .drop-zone {
            background-color: #2d3748; /* darker background */
            border-color: #667eea; /* indigo-400 */
        }
        html.dark .drop-zone.hover {
            border-color: #8b5cf6; /* purple-500 */
            background-color: #3a475a; /* slightly lighter dark */
        }
        html.dark input, html.dark textarea, html.dark select {
            background-color: #4a5568; /* darker input background */
            border-color: #667eea; /* indigo-400 */
            color: #e2e8f0; /* light text */
        }
        html.dark input::placeholder, html.dark textarea::placeholder {
            color: #a0aec0; /* lighter placeholder */
        }
        html.dark .bg-white.p-3.rounded-md.shadow-sm { /* For saved job description list items */
            background-color: #2d3748; /* darker */
        }
        html.dark .bg-white.p-2.rounded-md.shadow-sm { /* For required skills list items */
            background-color: #2d3748; /* darker */
        }
        html.dark .bg-white.p-6.rounded-lg.shadow-inner { /* For results display */
            background-color: #2d3748; /* darker */
        }
        html.dark .bg-gray-50.p-6.rounded-lg.shadow-inner { /* For batch results display */
            background-color: #2d3748; /* darker */
        }
        html.dark footer {
            background-color: #1a202c; /* darker footer */
        }
        html.dark .progress-bar-container {
            background-color: #4a5568; /* darker progress bar background */
        }
        html.dark .progress-bar-fill {
            background-color: #9f7aea; /* purple-400 */
            color: white; /* Ensure text is readable on purple */
        }
        /* Dropdown specific styles */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            /* Centering the dropdown */
            left: 50%;
            transform: translateX(-50%);
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        html.dark .dropdown-content {
            background-color: #2d3748; /* darker */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.4);
        }
        html.dark .dropdown-content a {
            color: #e2e8f0; /* light text */
        }
        html.dark .dropdown-content a:hover {
            background-color: #4a5568; /* darker hover */
        }
        /* Dashboard grid layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 0.5fr 1.5fr 0.5fr 2fr; /* Adjust column widths as needed */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        html.dark .dashboard-grid {
            border-bottom: 1px solid #4a5568; /* darker gray border */
        }
        .dashboard-grid-header {
            font-weight: bold;
            color: #4a5568; /* gray-700 */
            font-size: 0.875rem; /* text-sm */
            text-transform: uppercase;
        }
        html.dark .dashboard-grid-header {
            color: #a0aec0; /* lighter gray */
        }
        .dashboard-grid-row {
            background-color: #ffffff; /* white */
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        html.dark .dashboard-grid-row {
            background-color: #2d3748; /* darker white */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
        }
        .dashboard-grid-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        html.dark .dashboard-grid-row:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (Canvas provides these)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db, auth, userId;

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase authenticated. User ID:", userId);
                        // Load saved job descriptions and required skills after authentication
                        loadSavedJobDescriptionsAdvanced(); // Load for advanced analyzer
                        loadRequiredSkillsAdvanced(); // Load for advanced analyzer
                    } else {
                        // Check if __initial_auth_token is provided and non-empty
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (tokenError) {
                                // Changed from console.error to console.warn as this is a graceful fallback
                                console.warn("Error with custom token, falling back to anonymous:", tokenError);
                                // Fallback to anonymous if custom token fails (e.g., expired, invalid)
                                const anonymousUser = await signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                                console.log("Signed in anonymously. User ID:", userId);
                            }
                        } else {
                            // No custom token provided or it's empty, sign in anonymously
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                            console.log("Signed in anonymously. User ID:", userId);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        initializeFirebase();

        // --- Firestore Functions for Saved Job Descriptions (Advanced Analyzer) ---
        window.saveJobDescriptionAdvanced = async () => {
            if (!userId) {
                console.error("User not authenticated. Cannot save advanced job description.");
                return;
            }

            const jobDescriptionName = document.getElementById('newJobDescriptionNameAdvanced').value.trim();
            const jobDescriptionText = document.getElementById('jobRequirementsAdvanced').value.trim();

            if (!jobDescriptionName || !jobDescriptionText) {
                displayMessageBox('Please provide both a name and text for the advanced job description.', 'error');
                return;
            }

            try {
                const jobDescriptionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/advanced_job_descriptions`);
                await addDoc(jobDescriptionsCollectionRef, {
                    name: jobDescriptionName,
                    text: jobDescriptionText,
                    createdAt: new Date()
                });
                document.getElementById('newJobDescriptionNameAdvanced').value = ''; // Clear input
                displayMessageBox('Advanced Job description saved successfully!', 'info');
                loadSavedJobDescriptionsAdvanced(); // Refresh the list
            } catch (error) {
                console.error("Error saving advanced job description:", error);
                displayMessageBox(`Error saving advanced job description: ${error.message}`, 'error');
            }
        };

        window.loadSavedJobDescriptionsAdvanced = async () => {
            if (!userId) {
                console.log("User not authenticated yet. Skipping loading advanced job descriptions.");
                return;
            }

            const savedJobDescriptionsList = document.getElementById('savedJobDescriptionsListAdvanced');
            savedJobDescriptionsList.innerHTML = '<p class="text-gray-500 text-sm">Loading saved job descriptions...</p>';

            try {
                const jobDescriptionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/advanced_job_descriptions`);
                const q = query(jobDescriptionsCollectionRef);
                const querySnapshot = await getDocs(q);

                savedJobDescriptionsList.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    savedJobDescriptionsList.innerHTML = '<p class="text-gray-500 text-sm">No saved advanced job descriptions yet.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm mb-2 hover:bg-gray-100 transition duration-150';
                        li.innerHTML = `
                            <span class="cursor-pointer text-indigo-700 font-medium flex-grow text-left" data-id="${doc.id}" data-text="${encodeURIComponent(data.text)}">${data.name}</span>
                            <button class="ml-4 text-red-500 hover:text-red-700 transition duration-150" onclick="confirmDeleteJobDescriptionAdvanced('${doc.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 01-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        li.querySelector('span').addEventListener('click', (e) => {
                            document.getElementById('jobRequirementsAdvanced').value = decodeURIComponent(e.target.dataset.text);
                            document.getElementById('newJobDescriptionNameAdvanced').value = e.target.textContent.trim(); // Populate name field too
                        });
                        savedJobDescriptionsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Error loading advanced job descriptions:", error);
                savedJobDescriptionsList.innerHTML = '<p class="text-red-500 text-sm">Error loading advanced job descriptions.</p>';
            }
        };

        window.confirmDeleteJobDescriptionAdvanced = (docId) => {
            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxConfirm = document.getElementById('messageBoxConfirm');
            const messageBoxCancel = document.getElementById('messageBoxCancel');
            const messageBoxClose = document.getElementById('messageBoxClose');

            messageBoxText.textContent = "Are you sure you want to delete this advanced job description?";
            messageBoxConfirm.classList.remove('hidden');
            messageBoxCancel.classList.remove('hidden');
            messageBoxClose.classList.add('hidden');

            messageBoxConfirm.onclick = () => {
                deleteJobDescriptionAdvanced(docId);
                messageBox.classList.add('hidden');
            };
            messageBoxCancel.onclick = () => {
                messageBox.classList.add('hidden');
            };
            messageBox.classList.remove('hidden');
        };

        window.deleteJobDescriptionAdvanced = async (docId) => {
            if (!userId) {
                console.error("User not authenticated. Cannot delete advanced job description.");
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/advanced_job_descriptions`, docId);
                await deleteDoc(docRef);
                displayMessageBox('Advanced Job description deleted successfully!', 'info');
                loadSavedJobDescriptionsAdvanced(); // Refresh the list
            } catch (error) {
                console.error("Error deleting advanced job description:", error);
                displayMessageBox(`Error deleting advanced job description: ${error.message}`, 'error');
            }
        };

        // --- Firestore Functions for Required Skills (Advanced Analyzer) ---
        window.addRequiredSkillAdvanced = async () => {
            if (!userId) {
                console.error("User not authenticated. Cannot add advanced skill.");
                return;
            }

            const skillName = document.getElementById('newSkillInputAdvanced').value.trim();
            if (!skillName) {
                displayMessageBox('Please enter a skill to add to the advanced list.', 'error');
                return;
            }

            try {
                const skillsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/advanced_required_skills`);
                await addDoc(skillsCollectionRef, {
                    name: skillName,
                    createdAt: new Date()
                });
                document.getElementById('newSkillInputAdvanced').value = ''; // Clear input
                displayMessageBox('Advanced Skill added successfully!', 'info');
                loadRequiredSkillsAdvanced(); // Refresh the list
            } catch (error) {
                console.error("Error adding advanced skill:", error);
                displayMessageBox(`Error adding advanced skill: ${error.message}`, 'error');
            }
        };

        window.loadRequiredSkillsAdvanced = async () => {
            if (!userId) {
                console.log("User not authenticated yet. Skipping loading advanced skills.");
                return;
            }

            const requiredSkillsList = document.getElementById('requiredSkillsListAdvanced');
            requiredSkillsList.innerHTML = '<p class="text-gray-500 text-sm">Loading skills...</p>';

            try {
                const skillsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/advanced_required_skills`);
                const q = query(skillsCollectionRef);
                const querySnapshot = await getDocs(q);

                requiredSkillsList.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    savedJobDescriptionsList.innerHTML = '<p class="text-gray-500 text-sm">No required advanced skills added yet.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm mb-1 text-sm hover:bg-gray-100 transition duration-150';
                        li.innerHTML = `
                            <span class="text-gray-700 font-medium flex-grow text-left">${data.name}</span>
                            <button class="ml-2 text-red-500 hover:text-red-700 transition duration-150" onclick="confirmDeleteRequiredSkillAdvanced('${doc.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 01-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        requiredSkillsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Error loading advanced skills:", error);
                requiredSkillsList.innerHTML = '<p class="text-red-500 text-sm">Error loading advanced skills.</p>';
            }
        };

        window.confirmDeleteRequiredSkillAdvanced = (docId) => {
            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxConfirm = document.getElementById('messageBoxConfirm');
            const messageBoxCancel = document.getElementById('messageBoxCancel');
            const messageBoxClose = document.getElementById('messageBoxClose');

            messageBoxText.textContent = "Are you sure you want to delete this advanced skill?";
            messageBoxConfirm.classList.remove('hidden');
            messageBoxCancel.classList.remove('hidden');
            messageBoxClose.classList.add('hidden');

            messageBoxConfirm.onclick = () => {
                deleteRequiredSkillAdvanced(docId);
                messageBox.classList.add('hidden');
            };
            messageBoxCancel.onclick = () => {
                messageBox.classList.add('hidden');
            };
            messageBox.classList.remove('hidden');
        };

        window.deleteRequiredSkillAdvanced = async (docId) => {
            if (!userId) {
                console.error("User not authenticated. Cannot delete advanced skill.");
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/advanced_required_skills`, docId);
                await deleteDoc(docRef);
                displayMessageBox('Advanced Skill deleted successfully!', 'info');
                loadRequiredSkillsAdvanced(); // Refresh the list
            } catch (error) {
                console.error("Error deleting advanced skill:", error);
                displayMessageBox(`Error deleting advanced skill: ${error.message}`, 'error');
            }
        };

        // Custom message box display function (retained from previous version)
        window.displayMessageBox = (message, type = 'info') => {
            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxConfirm = document.getElementById('messageBoxConfirm');
            const messageBoxCancel = document.getElementById('messageBoxCancel');
            const messageBoxClose = document.getElementById('messageBoxClose');

            messageBoxText.textContent = message;
            if (type === 'info' || type === 'error') {
                messageBoxConfirm.classList.add('hidden');
                messageBoxCancel.classList.add('hidden');
                messageBoxClose.classList.remove('hidden');
                messageBoxClose.focus(); // Set focus to the close button
            } else { // For confirmation dialogs
                messageBoxConfirm.classList.remove('hidden');
                messageBoxCancel.classList.remove('hidden');
                messageBoxClose.classList.add('hidden');
                messageBoxConfirm.focus(); // Set focus to the confirm button
            }

            messageBoxClose.onclick = () => {
                messageBox.classList.add('hidden');
            };

            messageBox.className = `fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 ${type === 'error' ? 'border-red-500' : 'border-indigo-500'}`;
            messageBox.classList.remove('hidden');
        };

    </script>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header Section -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50 rounded-b-lg">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <!-- Agency Logo/Name -->
            <a href="index.html" class="text-3xl font-bold text-indigo-700 hover:text-indigo-900 transition duration-300 ease-in-out">
                Rekru.AI
            </a>
            <!-- Navigation Menu -->
            <nav class="mt-4 md:mt-0 flex items-center flex-grow justify-center">
                <ul class="flex space-x-6 header-nav-list">
                    <li><a href="index.html#about" class="text-gray-600 hover:text-indigo-700 font-medium transition duration-300 ease-in-out rounded-md px-3 py-2">About Us</a></li>
                    <li><a href="index.html#services" class="text-gray-600 hover:text-indigo-700 font-medium transition duration-300 ease-in-out rounded-md px-3 py-2">Services</a></li>
                    
                    <!-- Features Dropdown -->
                    <li class="relative dropdown">
                        <button class="text-gray-600 hover:text-indigo-700 font-medium transition duration-300 ease-in-out rounded-md px-3 py-2 flex items-center">
                            Features
                            <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-content absolute mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                            <a href="resume-analyzer.html" target="_blank" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Resume Analyzer</a>
                            <a href="advanced-analyzer.html" target="_blank" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Advanced Analyzer</a>
                            <a href="jd-generator.html" target="_blank" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Job Description Generator</a>
                            <a href="ai-sourcer.html" target="_blank" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">AI Sourcer/Contact Manager</a>
                            <a href="jd-poster.html" target="_blank" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Posting JD in my Platforms</a>
                        </div>
                    </li>
                    <li><a href="index.html#contact" class="text-gray-600 hover:text-indigo-700 font-medium transition duration-300 ease-in-out rounded-md px-3 py-2">Contact</a></li>
                </ul>

                <!-- Dark Mode Toggle -->
                <button id="darkModeToggle" class="ml-6 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300">
                    <svg id="sunIcon" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m15.325-7.757l-.707-.707M6.343 17.657l-.707.707M16.95 7.05l.707-.707M7.05 16.95l-.707.707M12 7a5 5 0 100 10 5 5 0 000-10z"></path>
                    </svg>
                    <svg id="moonIcon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>

                <!-- Language Selector -->
                <div class="relative dropdown ml-4">
                    <button class="text-gray-600 hover:text-indigo-700 font-medium transition duration-300 ease-in-out rounded-md px-3 py-2 flex items-center">
                        Language
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="dropdown-content absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                        <a href="#" onclick="changeLanguage('en')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">English</a>
                        <a href="#" onclick="changeLanguage('es')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Español</a>
                        <a href="#" onclick="changeLanguage('pt')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Português</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Advanced Resume Analyzer Section -->
    <section id="advanced-analyzer" class="py-16 px-4 bg-gray-100 rounded-xl shadow-lg mx-auto max-w-5xl mt-12">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold text-indigo-800 mb-8">Advanced Resume Analyzer (Batch Processing)</h2>
            <p class="text-lg text-gray-700 mb-10 max-w-3xl mx-auto">
                Upload multiple resumes to analyze them in a batch. Define specific job requirements and skills for this batch analysis.
            </p>

            <div class="flex flex-col md:flex-row gap-8">
                <!-- Left Column: Individual Job Descriptions & Required Skills (Advanced Analyzer) -->
                <div class="w-full md:w-1/3 bg-gray-50 p-6 rounded-lg shadow-md border-t-4 border-gray-400">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Job Requirements for Batch Analysis</h3>
                    <div class="mb-6">
                        <label for="jobRequirementsAdvanced" class="block text-gray-700 text-lg font-semibold mb-2 text-left">Overall Description:</label>
                        <textarea id="jobRequirementsAdvanced" rows="6" placeholder="e.g., 'Seeking a Senior Software Engineer for batch analysis...'" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        <input type="text" id="newJobDescriptionNameAdvanced" placeholder="Name to save this description" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 mb-2 mt-2">
                        <button onclick="saveJobDescriptionAdvanced()" class="w-full bg-green-600 text-white py-2 rounded-md font-semibold hover:bg-green-700 transition duration-300 ease-in-out shadow-md">Save Description for Batch</button>
                    </div>

                    <h4 class="text-xl font-bold text-gray-800 mb-4">Saved Job Descriptions for Batch</h4>
                    <ul id="savedJobDescriptionsListAdvanced" class="space-y-2 mb-8">
                        <p class="text-gray-500 text-sm">Loading saved job descriptions...</p>
                    </ul>

                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Required Skills for Batch Analysis</h3>
                    <div class="mb-4">
                        <input type="text" id="newSkillInputAdvanced" placeholder="Add a required skill for batch" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 mb-2">
                        <button onclick="addRequiredSkillAdvanced()" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">Add Skill for Batch</button>
                    </div>
                    <ul id="requiredSkillsListAdvanced" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading skills...</p>
                    </ul>
                </div>

                <!-- Right Column: Analyzer Inputs and Results -->
                <div class="w-full md:w-2/3 bg-gray-50 p-8 rounded-lg shadow-md">
                    <div class="mb-6 text-left">
                        <label for="multipleResumeFiles" class="block text-gray-700 text-lg font-semibold mb-2">Upload Multiple Resumes (PDF, DOCX, TXT):</label>
                        <div id="multipleDropZone" class="drop-zone mb-4 cursor-pointer">
                            <p class="text-gray-600">Drag & Drop multiple resumes here, or</p>
                            <input type="file" id="multipleResumeFiles" accept=".pdf,.doc,.docx,.txt" multiple class="hidden">
                            <button type="button" id="multipleBrowseButton" class="mt-2 bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition duration-300">Browse Files</button>
                            <ul id="selectedFilesList" class="mt-4 text-sm text-gray-700 list-disc list-inside text-left"></ul>
                        </div>
                    </div>

                    <button id="analyzeMultipleButton" class="w-full bg-purple-700 text-white py-3 rounded-md font-semibold hover:bg-purple-800 transition duration-300 ease-in-out shadow-md transform hover:scale-105">
                        Analyzing Candidates
                    </button>

                    <div id="multipleLoadingIndicator" class="mt-8 text-center hidden">
                        <div class="progress-bar-container">
                            <div id="progressBarFill" class="progress-bar-fill">0%</div>
                        </div>
                        <p id="progressBarText" class="mt-4 text-purple-700 font-medium">Analyzing resumes, please wait...</p>
                    </div>

                    <div id="multipleErrorMessage" class="mt-4 text-red-600 font-medium hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Candidate Dashboard Section -->
    <section id="candidate-dashboard" class="py-16 px-4 bg-gray-50 rounded-xl shadow-lg mx-auto max-w-6xl mt-12 hidden">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold text-indigo-800 mb-8">Candidate Dashboard</h2>
            <p class="text-lg text-gray-700 mb-10 max-w-3xl mx-auto">
                View and manage your analyzed candidates. Use the controls below to sort and filter the results.
            </p>

            <!-- Dashboard Controls -->
            <div class="mb-6 p-4 bg-gray-100 rounded-md shadow-sm dark:bg-gray-700">
                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">Dashboard Controls</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="sortOrder" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sort By Match Score:</label>
                        <select id="sortOrder" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            <option value="desc">Highest Match First</option>
                            <option value="asc">Lowest Match First</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterKeyword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Keyword:</label>
                        <input type="text" id="filterKeyword" placeholder="e.g., 'React', 'Cloud'" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>
                    <div>
                        <label for="filterYearsExperience" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Min. Years Experience:</label>
                        <input type="number" id="filterYearsExperience" min="0" placeholder="e.g., 5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    </div>
                </div>
                <button id="applyDashboardFilters" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md font-semibold hover:bg-indigo-700 transition duration-300 ease-in-out shadow-md">Apply Filters & Sort</button>
            </div>

            <div id="dashboardTable" class="bg-white rounded-lg shadow-inner overflow-hidden dark:bg-gray-700">
                <!-- Table Header -->
                <div class="dashboard-grid dashboard-grid-header">
                    <div>Candidate</div>
                    <div>Match %</div>
                    <div>Skills Match</div>
                    <div>Years Exp.</div>
                    <div>Recruiter Analysis</div>
                </div>
                <!-- Candidate Rows will be dynamically inserted here -->
                <div id="dashboardBody">
                    <p class="text-gray-600 p-4">Upload resumes in the Advanced Analyzer to see results here.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-8 mt-12 rounded-t-lg">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2025 Rekru.AI. All rights reserved.</p>
            <p class="mt-2">Innovating Talent Acquisition with Intelligence.</p>
        </div>
    </footer>

    <!-- Custom Message Box (for alerts/confirms) -->
    <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center border-t-4 border-indigo-500">
            <p id="messageBoxText" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="messageBoxConfirm" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300 hidden">Confirm</button>
                <button id="messageBoxCancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition duration-300 hidden">Cancel</button>
                <button id="messageBoxClose" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition duration-300 hidden">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elements for Advanced Analyzer
            const multipleResumeFilesInput = document.getElementById('multipleResumeFiles');
            const multipleBrowseButton = document.getElementById('multipleBrowseButton');
            const selectedFilesList = document.getElementById('selectedFilesList');
            const analyzeMultipleButton = document.getElementById('analyzeMultipleButton');
            const multipleLoadingIndicator = document.getElementById('multipleLoadingIndicator');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressBarText = document.getElementById('progressBarText');
            const multipleErrorMessage = document.getElementById('multipleErrorMessage');
            const multipleDropZone = document.getElementById('multipleDropZone');

            // Elements for Advanced Analyzer's OWN job description and skills
            const jobRequirementsAdvanced = document.getElementById('jobRequirementsAdvanced');
            const newJobDescriptionNameAdvanced = document.getElementById('newJobDescriptionNameAdvanced');
            const savedJobDescriptionsListAdvanced = document.getElementById('savedJobDescriptionsListAdvanced');
            const newSkillInputAdvanced = document.getElementById('newSkillInputAdvanced');
            const requiredSkillsListAdvanced = document.getElementById('requiredSkillsListAdvanced');

            // Dashboard controls
            const candidateDashboardSection = document.getElementById('candidate-dashboard');
            const sortOrderSelect = document.getElementById('sortOrder');
            const filterKeywordInput = document.getElementById('filterKeyword');
            const filterYearsExperienceInput = document.getElementById('filterYearsExperience');
            const applyDashboardFiltersButton = document.getElementById('applyDashboardFilters');
            const dashboardBody = document.getElementById('dashboardBody');

            let uploadedMultipleFiles = []; // For advanced analyzer
            let allAnalyzedResults = []; // Store all results for dashboard manipulation

            // --- Dark Mode Functionality ---
            const darkModeToggle = document.getElementById('darkModeToggle');
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');

            function applyDarkMode(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            // Check for saved dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                applyDarkMode(true);
            } else {
                applyDarkMode(false);
            }

            darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyDarkMode(!isDark);
                localStorage.setItem('darkMode', !isDark);
            });

            // --- Language Settings Functionality ---
            window.changeLanguage = (langCode) => {
                document.documentElement.lang = langCode;
                localStorage.setItem('language', langCode);
                // In a real application, you would load translation files here
                displayMessageBox(`Language set to: ${langCode.toUpperCase()}`, 'info');
            };

            // Apply saved language preference
            const savedLanguage = localStorage.getItem('language');
            if (savedLanguage) {
                document.documentElement.lang = savedLanguage;
            }

            // --- Dropdown Menu Functionality ---
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                const button = dropdown.querySelector('button');
                const content = dropdown.querySelector('.dropdown-content');

                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent closing immediately if another dropdown is clicked
                    // Close other open dropdowns
                    document.querySelectorAll('.dropdown-content').forEach(otherContent => {
                        if (otherContent !== content) {
                            otherContent.style.display = 'none';
                        }
                    });
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });

                // Close dropdown if clicked outside
                document.addEventListener('click', (event) => {
                    if (!dropdown.contains(event.target)) {
                        content.style.display = 'none';
                    }
                });
            });

            // --- Custom Message Box Functions (retained) ---
            window.displayMessageBox = (message, type = 'info') => {
                const messageBox = document.getElementById('messageBox');
                const messageBoxText = document.getElementById('messageBoxText');
                const messageBoxConfirm = document.getElementById('messageBoxConfirm');
                const messageBoxCancel = document.getElementById('messageBoxCancel');
                const messageBoxClose = document.getElementById('messageBoxClose');

                messageBoxText.textContent = message;
                if (type === 'info' || type === 'error') {
                    messageBoxConfirm.classList.add('hidden');
                    messageBoxCancel.classList.add('hidden');
                    messageBoxClose.classList.remove('hidden');
                    messageBoxClose.focus(); // Set focus to the close button
                } else { // For confirmation dialogs
                    messageBoxConfirm.classList.remove('hidden');
                    messageBoxCancel.classList.remove('hidden');
                    messageBoxClose.classList.add('hidden');
                    messageBoxConfirm.focus(); // Set focus to the confirm button
                }

                messageBoxClose.onclick = () => {
                    messageBox.classList.add('hidden');
                };

                messageBox.className = `fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 ${type === 'error' ? 'border-red-500' : 'border-indigo-500'}`;
                messageBox.classList.remove('hidden');
            };

            // --- Advanced Resume Analyzer Logic ---

            // Function to render batch results
            function renderBatchResults(resultsToRender) {
                dashboardBody.innerHTML = ''; // Clear previous results
                if (resultsToRender.length === 0) {
                    dashboardBody.innerHTML = '<p class="text-gray-600 p-4">No candidates match your current filters.</p>';
                    return;
                }

                resultsToRender.forEach(result => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'dashboard-grid dashboard-grid-row';
                    
                    if (result.error) {
                        rowDiv.innerHTML = `
                            <div class="font-semibold text-gray-900 dark:text-gray-200">${result.fileName}</div>
                            <div class="text-red-600 col-span-4">Error: ${result.error}</div>
                        `;
                    } else {
                        const matchStatusColor = result.data.matchScore >= 70 ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400';

                        // Get required skills for the advanced analyzer
                        const advancedSkillsElements = Array.from(requiredSkillsListAdvanced.querySelectorAll('span'));
                        const advancedRequiredSkillsArray = advancedSkillsElements.map(span => span.textContent.trim());

                        let skillsSummary = '';
                        if (advancedRequiredSkillsArray.length > 0) {
                            const matchedCount = result.data.matchedSkills.filter(skill => advancedRequiredSkillsArray.some(reqSkill => skill.toLowerCase().includes(reqSkill.toLowerCase()))).length;
                            const missingCount = advancedRequiredSkillsArray.filter(reqSkill => !result.data.matchedSkills.some(skill => skill.toLowerCase().includes(reqSkill.toLowerCase()))).length;
                            skillsSummary = `<span class="text-green-700 dark:text-green-400">✅ ${matchedCount}</span> / <span class="text-red-700 dark:text-red-400">❌ ${missingCount}</span>`;
                        } else {
                            skillsSummary = `<span class="text-gray-600 dark:text-gray-400">N/A</span>`;
                        }

                        rowDiv.innerHTML = `
                            <div class="font-semibold text-gray-900 dark:text-gray-200">${result.fileName}</div>
                            <div class="font-bold ${matchStatusColor}">${result.data.matchScore}%</div>
                            <div>${skillsSummary}</div>
                            <div class="text-gray-700 dark:text-gray-300">${result.data.yearsOfExperience} years</div>
                            <div class="text-gray-700 dark:text-gray-300 text-sm">${result.data.recruiterAnalysis.substring(0, 100)}...</div>
                        `;
                    }
                    dashboardBody.appendChild(rowDiv);
                });
            }

            // Function to apply filters and sorting to allAnalyzedResults and render
            function applyDashboardControls() {
                let filteredResults = [...allAnalyzedResults]; // Create a copy to manipulate

                const keyword = filterKeywordInput.value.toLowerCase().trim();
                if (keyword) {
                    filteredResults = filteredResults.filter(result => {
                        if (result.data) {
                            const fileName = result.fileName.toLowerCase();
                            const summary = result.data.profileSummary.toLowerCase();
                            const analysis = result.data.recruiterAnalysis.toLowerCase();
                            // Combine all skills for keyword search
                            const allSkills = [...result.data.matchedSkills, ...(result.data.missingSkills || [])].map(s => s.toLowerCase()).join(' '); // Ensure missingSkills is an array
                            return fileName.includes(keyword) || summary.includes(keyword) || analysis.includes(keyword) || allSkills.includes(keyword);
                        }
                        return false; // Don't include error results in keyword filter
                    });
                }

                const minYearsExperience = parseInt(filterYearsExperienceInput.value);
                if (!isNaN(minYearsExperience) && minYearsExperience >= 0) {
                    filteredResults = filteredResults.filter(result => {
                        return result.data && result.data.yearsOfExperience >= minYearsExperience;
                    });
                }

                const sortOrder = sortOrderSelect.value; // 'asc' or 'desc'
                filteredResults.sort((a, b) => {
                    const scoreA = a.data ? a.data.matchScore : -1; // Assign -1 to error results for sorting
                    const scoreB = b.data ? b.data.matchScore : -1;

                    if (sortOrder === 'desc') {
                        return scoreB - scoreA;
                    } else {
                        return scoreA - scoreB;
                    }
                });

                renderBatchResults(filteredResults);
            }

            // Event listener for applying filters/sort
            applyDashboardFiltersButton.addEventListener('click', applyDashboardControls);


            // Handle multiple file input change
            multipleResumeFilesInput.addEventListener('change', (event) => {
                uploadedMultipleFiles = Array.from(event.target.files);
                updateSelectedFilesList();
            });

            // Handle multiple browse button click
            multipleBrowseButton.addEventListener('click', () => {
                multipleResumeFilesInput.click();
            });

            // Drag and Drop functionality for multiple analyzer
            multipleDropZone.addEventListener('dragover', (event) => {
                event.preventDefault();
                multipleDropZone.classList.add('hover');
                console.log('Dragover on multiple drop zone'); // Debugging log
            });

            multipleDropZone.addEventListener('dragleave', () => {
                multipleDropZone.classList.remove('hover');
                console.log('Dragleave on multiple drop zone'); // Debugging log
            });

            multipleDropZone.addEventListener('drop', (event) => {
                event.preventDefault();
                multipleDropZone.classList.remove('hover');

                const files = event.dataTransfer.files;
                console.log('Drop on multiple drop zone. Files:', files); // Debugging log
                if (files.length > 0) {
                    uploadedMultipleFiles = uploadedMultipleFiles.concat(Array.from(files));
                    updateSelectedFilesList();
                    console.log('Multiple files added. Total files:', uploadedMultipleFiles.length); // Debugging log
                } else {
                    console.log('No files dropped on multiple drop zone.'); // Debugging log
                }
            });

            function updateSelectedFilesList() {
                selectedFilesList.innerHTML = '';
                if (uploadedMultipleFiles.length === 0) {
                    selectedFilesList.innerHTML = '<li>No files selected.</li>';
                } else {
                    uploadedMultipleFiles.forEach((file, index) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm mb-1 text-sm';
                        li.innerHTML = `
                            <span>${file.name}</span>
                            <button class="ml-2 text-red-500 hover:text-red-700 transition duration-150" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 01-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        li.querySelector('button').addEventListener('click', (e) => {
                            const indexToRemove = parseInt(e.currentTarget.dataset.index); // Use currentTarget for event delegation
                            uploadedMultipleFiles.splice(indexToRemove, 1);
                            updateSelectedFilesList();
                        });
                        selectedFilesList.appendChild(li);
                    });
                }
            }

            analyzeMultipleButton.addEventListener('click', async () => {
                const overallRequirements = jobRequirementsAdvanced.value.trim(); // Use advanced JD
                const skillsElements = Array.from(requiredSkillsListAdvanced.querySelectorAll('span')); // Use advanced skills
                const requiredSkillsArray = skillsElements.map(span => span.textContent.trim());
                const requiredSkillsString = requiredSkillsArray.length > 0 ? `Explicitly required skills: ${requiredSkillsArray.join(', ')}.` : '';
                const combinedRequirements = `${overallRequirements}\n\n${requiredSkillsString}`.trim();

                multipleErrorMessage.classList.add('hidden');
                allAnalyzedResults = []; // Clear previous batch results

                if (uploadedMultipleFiles.length === 0) {
                    multipleErrorMessage.textContent = 'Please upload at least one resume file for batch analysis.';
                    multipleErrorMessage.classList.remove('hidden');
                    return;
                }

                if (!combinedRequirements) {
                    multipleErrorMessage.textContent = 'Please enter job requirements or add some required skills for batch analysis.';
                    multipleErrorMessage.classList.remove('hidden');
                    return;
                }

                progressBarFill.style.width = '0%';
                progressBarFill.textContent = '0%';
                progressBarText.textContent = 'Analyzing resumes, please wait...';
                multipleLoadingIndicator.classList.remove('hidden'); // Show progress bar
                candidateDashboardSection.classList.add('hidden'); // Hide dashboard until results are ready

                let processedCount = 0;
                const totalFiles = uploadedMultipleFiles.length;

                for (const file of uploadedMultipleFiles) {
                    try {
                        let resumeContentParts = [];
                        let fileType = file.type;

                        if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || file.name.endsWith('.docx')) {
                            const arrayBuffer = await file.arrayBuffer();
                            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                            const docxText = result.value;

                            if (!docxText || docxText.trim().length === 0) {
                                console.warn(`Skipping ${file.name}: Could not extract text from DOCX.`);
                                allAnalyzedResults.push({ fileName: file.name, data: null, error: 'Could not extract text from DOCX.' });
                                continue;
                            }
                            resumeContentParts.push({ text: `Extracted text from DOCX:\n${docxText}` });
                            fileType = 'text/plain';
                        } else if (fileType === 'application/pdf' || fileType.startsWith('text/')) {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            await new Promise((resolve, reject) => {
                                reader.onload = () => {
                                    const base64Data = reader.result.split(',')[1];
                                    resumeContentParts.push({
                                        inlineData: {
                                            mimeType: fileType,
                                            data: base64Data
                                        }
                                    });
                                    resolve();
                                };
                                reader.onerror = reject;
                            });
                        } else {
                            console.warn(`Skipping ${file.name}: Unsupported file type.`);
                            allAnalyzedResults.push({ fileName: file.name, error: 'Unsupported file type.' });
                            continue;
                        }

                        let chatHistory = [];
                        const prompt = `You are an expert resume analyzer. Analyze the provided resume content against the given job requirements. The resume content will either be embedded directly as a document or provided as extracted plain text.

                        Job Requirements:
                        ${combinedRequirements}

                        Resume Content:

                        Please provide a structured JSON response with the following fields:
                        - "profileSummary": A concise summary of the candidate's professional profile based on the resume content.
                        - "matchScore": A percentage score indicating how well the resume content matches the job requirements. (e.g., 85 for 85%)
                        - "matchedSkills": An array of skills from the resume content that directly match the job requirements, especially focusing on the explicitly required skills if provided.
                        - "missingSkills": An array of key skills from the job requirements (especially the explicitly required skills) that are not clearly present in the resume content.
                        - "yearsOfExperience": A numerical value representing the total years of relevant professional experience clearly stated or inferable from the resume. If experience is not explicitly stated or cannot be reasonably inferred (e.g., only academic projects, no dates), return 0. Focus on full-time professional roles.
                        - "recruiterAnalysis": A detailed analysis from a recruiter's perspective, including strengths, weaknesses, and overall suitability for the role, based on the resume content.`;

                        chatHistory.push({
                            role: "user",
                            parts: [{ text: prompt }].concat(resumeContentParts)
                        });

                        const payload = {
                            contents: chatHistory,
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        "profileSummary": { "type": "STRING" },
                                        "matchScore": { "type": "NUMBER" },
                                        "matchedSkills": {
                                            "type": "ARRAY",
                                            "items": { "type": "STRING" }
                                        },
                                        "missingSkills": {
                                            "type": "ARRAY",
                                            "items": { "type": "STRING" }
                                    },
                                    "yearsOfExperience": { "type": "NUMBER" }, // Added years of experience
                                    "recruiterAnalysis": { "type": "STRING" }
                                },
                                "propertyOrdering": ["profileSummary", "matchScore", "matchedSkills", "missingSkills", "yearsOfExperience", "recruiterAnalysis"]
                                }
                            }
                        };

                        // IMPORTANT: Replace "YOUR_GENERATED_API_KEY_HERE" with your actual Gemini API key.
                        const apiKey = "AIzaSyB65d-ZEnTOnejGiZNS306ReDS0qQ8ayZs"; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            
                            if (!jsonText || typeof jsonText !== 'string' || jsonText.trim().length < 50) {
                                console.warn(`Skipping ${file.name}: AI returned empty or very short response.`);
                                allAnalyzedResults.push({ fileName: file.name, data: null, error: 'AI returned empty or very short response.' });
                                continue;
                            }

                            let parsedJson;
                            try {
                                parsedJson = JSON.parse(jsonText);
                                allAnalyzedResults.push({ fileName: file.name, data: parsedJson, error: null });
                            } catch (parseError) {
                                console.warn(`Skipping ${file.name}: Error parsing AI response.`, parseError);
                                allAnalyzedResults.push({ fileName: file.name, data: null, error: 'Error parsing AI response.' });
                            }
                        } else {
                            console.warn(`Skipping ${file.name}: Failed to get valid response from AI.`);
                            allAnalyzedResults.push({ fileName: file.name, data: null, error: 'Failed to get valid response from AI.' });
                        }
                    } catch (error) {
                        console.error(`Error analyzing ${file.name}:`, error);
                        allAnalyzedResults.push({ fileName: file.name, data: null, error: `Analysis failed: ${error.message}` });
                    } finally {
                        processedCount++;
                        const percentage = Math.round((processedCount / totalFiles) * 100);
                        progressBarFill.style.width = `${percentage}%`;
                        progressBarFill.textContent = `${percentage}%`;
                        progressBarText.textContent = `Analyzing resumes: ${processedCount} of ${totalFiles} processed...`;
                    }
                }

                multipleLoadingIndicator.classList.add('hidden');
                candidateDashboardSection.classList.remove('hidden'); // Show the dashboard
                // Initial render of dashboard after all analyses are done
                applyDashboardControls();
            });
        });
    </script>

</body>
</html>
